<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sub Converter Pro + Multi-File Sync</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    :root {
      --bg: #f9fafb;
      --text: #111827;
      --card: #ffffff;
      --border: #e5e7eb;
      --btn-primary: #3b82f6;
      --btn-success: #10b981;
      --btn-danger: #ef4444;
    }
    .dark {
      --bg: #111827;
      --text: #f9fafb;
      --card: #1f2937;
      --border: #374151;
      --btn-primary: #60a5fa;
      --btn-success: #34d399;
      --btn-danger: #f87171;
    }
    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 16px;
      transition: background 0.3s, color 0.3s;
      font-size: 15px;
      line-height: 1.6;
    }
    .container { max-width: 900px; margin: auto; }
    h1 { text-align: center; margin-bottom: 24px; }
    textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      margin-bottom: 12px;
      font-size: 14px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: transform 0.1s;
    }
    button:hover { transform: translateY(-1px); }
    .btn-primary { background: var(--btn-primary); color: #fff; }
    .btn-success { background: var(--btn-success); color: #fff; }
    .btn-danger { background: var(--btn-danger); color: #fff; }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .flex { display: flex; justify-content: space-between; align-items: flex-start; }
    .proxy-info h3 { margin: 0 0 4px 0; font-size: 16px; }
    .proxy-info p { margin: 0; font-size: 13px; opacity: 0.8; }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      background: var(--border);
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0.95;
      animation: fadeIn 0.3s;
      z-index: 1000;
    }
    .toast.success { background: var(--btn-success); }
    .toast.error { background: var(--btn-danger); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”— Sub Converter Pro + Multi-File Sync</h1>

    <div class="controls">
      <select id="interfaceSelect">
        <option value="eth0">eth0</option>
        <option value="eth1">eth1</option>
        <option value="usb0">usb0</option>
        <option value="wifi0">wifi0</option>
      </select>
      <select id="targetFile">
        <option value="proxies/id.yaml">ğŸ‡®ğŸ‡© Indonesia</option>
        <option value="proxies/sg.yaml">ğŸ‡¸ğŸ‡¬ Singapore</option>
        <option value="proxies/random.yaml">ğŸ² Random</option>
      </select>
      <button id="darkModeToggle" class="btn-primary">ğŸŒ™ Dark Mode</button>
    </div>

    <textarea id="input" placeholder="Paste VLESS, Trojan, VMess links here (one per line)"></textarea>

    <div class="btn-group">
      <button id="convertBtn" class="btn-primary">Convert</button>
      <button id="copyAllBtn" class="btn-success" style="display:none">ğŸ“‹ Copy All</button>
      <button id="saveToGithubBtn" class="btn-primary" style="display:none">ğŸ’¾ Save</button>
    </div>

    <div class="btn-group" id="secondaryActions" style="display:none">
      <button id="autoSaveAllBtn" class="btn-success">ğŸ¤– Auto-Save All</button>
      <button id="clearIdBtn" class="btn-danger">ğŸ—‘ï¸ Clear ID</button>
      <button id="clearSgBtn" class="btn-danger">ğŸ—‘ï¸ Clear SG</button>
      <button id="clearRandomBtn" class="btn-danger">ğŸ—‘ï¸ Clear Random</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    // === Dark Mode ===
    const savedMode = localStorage.getItem('darkMode');
    if (savedMode === 'true') document.body.classList.add('dark');
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.onclick = () => {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
      darkModeToggle.textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ğŸŒ™ Dark Mode';
    };

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.className = `toast ${type}`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // === Parsing ===
    function parseVLESS(uri) {
      let [mainPart, fragment] = uri.replace('vless://', '').split('#');
      let name = fragment ? decodeURIComponent(fragment) : 'Unnamed VLESS';
      let [main, params] = mainPart.split('?');
      let [uuid, serverPort] = main.split('@');
      let [server, port] = serverPort.split(':');
      let paramObj = {};
      if (params) new URLSearchParams(params).forEach((v, k) => paramObj[k] = v);
      return { name, type: 'vless', server, port: parseInt(port), uuid,
        tls: paramObj.security === 'tls', servername: paramObj.sni || server,
        network: paramObj.type || 'tcp',
        ws_opts: paramObj.type === 'ws' ? { path: paramObj.path || '/', headers: { Host: paramObj.host || server } } : null };
    }

    function parseTrojan(uri) {
      let [mainPart, fragment] = uri.replace('trojan://', '').split('#');
      let name = fragment ? decodeURIComponent(fragment) : 'Unnamed Trojan';
      let [main, params] = mainPart.split('?');
      let [password, serverPort] = main.split('@');
      let [server, port] = serverPort.split(':');
      let paramObj = {};
      if (params) new URLSearchParams(params).forEach((v, k) => paramObj[k] = v);
      return { name, type: 'trojan', server, port: parseInt(port), password,
        sni: paramObj.sni || server, network: paramObj.type || 'tcp',
        ws_opts: paramObj.type === 'ws' ? { path: paramObj.path || '/', headers: { Host: paramObj.host || server } } : null };
    }

    function parseVMess(uri) {
      let jsonStr = atob(uri.replace('vmess://', ''));
      let data; try { data = JSON.parse(jsonStr); } catch { return null; }
      return { name: data.ps || 'Unnamed VMess', type: 'vmess', server: data.add,
        port: parseInt(data.port), uuid: data.id, alterId: data.aid ? parseInt(data.aid) : 0,
        cipher: data.scy || 'auto', tls: data.tls === 'tls', network: data.net || 'tcp',
        ws_opts: data.net === 'ws' ? { path: data.path || '/', headers: { Host: data.host || data.add } } : null,
        servername: data.sni || data.add };
    }

    function parseURI(uri) {
      if (uri.startsWith('vless://')) return parseVLESS(uri);
      if (uri.startsWith('trojan://')) return parseTrojan(uri);
      if (uri.startsWith('vmess://')) return parseVMess(uri);
      return null;
    }

    function proxyToYaml(proxy, interfaceName) {
      let yaml = `  - name: "${proxy.name}"\n`;
      yaml += `    type: ${proxy.type}\n`;
      yaml += `    server: ${proxy.server}\n`;
      yaml += `    port: ${proxy.port}\n`;
      if (proxy.type === 'vless' || proxy.type === 'vmess') yaml += `    uuid: ${proxy.uuid}\n`;
      if (proxy.type === 'trojan') yaml += `    password: ${proxy.password}\n`;
      if (proxy.type === 'vmess') { yaml += `    alterId: ${proxy.alterId}\n    cipher: ${proxy.cipher}\n`; }
      if (proxy.tls !== undefined) { yaml += `    tls: ${proxy.tls}\n    servername: ${proxy.servername}\n`; }
      if (proxy.sni !== undefined) yaml += `    sni: ${proxy.sni}\n`;
      yaml += `    skip-cert-verify: true\n    network: ${proxy.network}\n`;
      if (proxy.ws_opts) yaml += `    ws-opts:\n      path: ${proxy.ws_opts.path}\n      headers:\n        Host: ${proxy.ws_opts.headers.Host}\n`;
      yaml += `    interface-name: ${interfaceName}\n    udp: true\n`;
      return yaml;
    }

    async function categorizeProxy(proxy) {
      const name = proxy.name.toLowerCase();
      if (name.includes('ğŸ‡®ğŸ‡©') || name.includes('indonesia')) return 'proxies/id.yaml';
      if (name.includes('ğŸ‡¸ğŸ‡¬') || name.includes('singapore') || name.includes(' sg ')) return 'proxies/sg.yaml';
      try {
        const res = await fetch(`https://ip-api.com/json/${proxy.server}?fields=countryCode`);
        if (res.ok) {
          const data = await res.json();
          if (data.countryCode === 'ID') return 'proxies/id.yaml';
          if (data.countryCode === 'SG') return 'proxies/sg.yaml';
        }
      } catch {}
      return 'proxies/random.yaml';
    }

    const inputEl = document.getElementById('input');
    const convertBtn = document.getElementById('convertBtn');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const saveToGithubBtn = document.getElementById('saveToGithubBtn');
    const autoSaveAllBtn = document.getElementById('autoSaveAllBtn');
    const clearIdBtn = document.getElementById('clearIdBtn');
    const clearSgBtn = document.getElementById('clearSgBtn');
    const clearRandomBtn = document.getElementById('clearRandomBtn');
    const resultsEl = document.getElementById('results');
    const interfaceSelect = document.getElementById('interfaceSelect');
    const targetFileSelect = document.getElementById('targetFile');

    let proxies = [];

    convertBtn.onclick = async () => {
      const lines = inputEl.value.split('\n').filter(x => x.trim());
      proxies = lines.map(parseURI).filter(x => x !== null);
      if (!proxies.length) return showToast("No valid proxies found", "error");

      for (let proxy of proxies) proxy.category = await categorizeProxy(proxy);
      let allYaml = "proxies:\n";
      let html = '';
      proxies.forEach(proxy => {
        const yaml = proxyToYaml(proxy, interfaceSelect.value);
        allYaml += yaml;
        html += `<div class="card"><div class="flex"><div class="proxy-info"><h3>${proxy.name}</h3><p>${proxy.type.toUpperCase()} â€¢ ${proxy.server}:${proxy.port}</p><p><span class="tag">${proxy.category.split('/')[1].replace('.yaml','').toUpperCase()}</span></p></div><button class="btn-success" onclick="navigator.clipboard.writeText(\`${yaml.replace(/`/g,'\\`')}\`).then(()=>showToast('Copied!'))">Copy</button></div></div>`;
      });
      resultsEl.innerHTML = html;
      copyAllBtn.style.display = saveToGithubBtn.style.display = 'inline-block';
      document.getElementById('secondaryActions').style.display = 'flex';
      copyAllBtn.onclick = () => navigator.clipboard.writeText(allYaml).then(()=>showToast("All copied!"));
    };

    saveToGithubBtn.onclick = async () => {
      const owner = "bangfear";
      const repo = "sub-converter";
      const filename = targetFileSelect.value;
      const res = await fetch('/api/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ proxies, filename, owner, repo }) });
      const result = await res.json();
      if (result.success) showToast(`Saved to ${filename}`); else showToast("Save failed","error");
    };

    autoSaveAllBtn.onclick = async () => {
      const owner = "bangfear";
      const repo = "sub-converter";
      const groups = { 'proxies/id.yaml': [], 'proxies/sg.yaml': [], 'proxies/random.yaml': [] };
      for (let proxy of proxies) groups[proxy.category].push(proxy);
      let successCount = 0;
      for (let [filename, proxyList] of Object.entries(groups)) {
        if (!proxyList.length) continue;
        const res = await fetch('/api/save',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ proxies: proxyList, filename, owner, repo }) });
        const result = await res.json();
        if (result.success) successCount++;
      }
      showToast(`${successCount} files updated`);
    };

    async function clearFile(filename){
      const owner = "bangfear"; const repo = "sub-converter";
      const res = await fetch('/api/clear',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename, owner, repo }) });
      const result = await res.json();
      if (result.success) showToast(`${filename} cleared`); else showToast("Clear failed","error");
    }
    clearIdBtn.onclick=()=>clearFile('proxies/id.yaml');
    clearSgBtn.onclick=()=>clearFile('proxies/sg.yaml');
    clearRandomBtn.onclick=()=>clearFile('proxies/random.yaml');
  </script>
</body>
</html>
